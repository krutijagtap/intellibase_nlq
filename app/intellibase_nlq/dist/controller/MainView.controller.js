sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/StandardListItem","sap/m/MessageBox","sap/m/BusyDialog","../lib/jspdf/jspdf.umd.min","../lib/dompurify/purify.min","../lib/html2canvas/html2canvas.min"],(t,e,o,s,n,i,a)=>{"use strict";return t.extend("intellibasenlq.controller.MainView",{onInit:async function(){this._oODataModel=this.getOwnerComponent().getModel();this._oCategoryModel=new e;this._oProductModel=new e;this.getView().setModel(this._oCategoryModel,"categoriesModel");this.getView().setModel(this._oProductModel,"productsModel");this._oCategorySelect=this.byId("categorySelect");this._oProductSelect=this.byId("productSelect");this._oPromptList=this.byId("promptList");await this.loadCategories();await this.loadProducts();this.loadPrompts("All Categories","All Products")},loadCategories:async function(){const t=this._oODataModel.bindContext("/DistinctCategories(...)");await t.execute();const o=t.getBoundContext().getObject();const s=o.value||[];s.unshift({category:"All Categories"});const n=new e(s);this.getView().setModel(n,"categories")},loadProducts:async function(t){const o=this._oODataModel.bindContext("/DistinctProducts(...)");await o.execute();const s=o.getBoundContext().getObject();const n=s.value||[];n.unshift({product:"All Products"});const i=new e(n);this.getView().setModel(i,"products")},loadPrompts:function(t,e){const i=[];if(t&&t!=="All Categories"){i.push(new o("category",s.EQ,t))}if(e&&e!=="All Products"){i.push(new o("product",s.EQ,e))}const a=this._oPromptList.getBinding("items");if(a){a.filter(i)}else{this._oPromptList.bindItems({path:"/PromptsData",template:new n({title:"{prompt}",description:"{description}"}),filters:i})}},onCategoryChange:function(t){const e=t.getParameter("selectedItem")?.getKey();const o=this._oProductSelect.getSelectedKey();this.loadPrompts(e,o)},onProductChange:function(t){const e=t.getParameter("selectedItem")?.getKey();const o=this._oCategorySelect.getSelectedKey();this.loadPrompts(o,e)},onSelectPrompt:async function(t){this.byId("legendSection").setContent("");const e=t.getParameter("listItem").getBindingContext();const o=e.getObject();const s=o.prompt;const n=this.getView().getModel();const i=n.bindContext("/getPrompt(...)");i.setParameter("prompt",s);try{await i.execute();const t=i.getBoundContext().getObject();const e=Object.entries(t).filter(([t,e])=>t.startsWith("key")&&e);let o=e.map(([e,o],s)=>({value:o,description:t[e.replace("key","sel")],number:s+1}));o=o.map(t=>{const e=s.toLowerCase().indexOf(t.value.toLowerCase());return e>=0?{...t,index:e}:null}).filter(Boolean).sort((t,e)=>t.index-e.index).map((t,e)=>({...t,number:e+1}));const n=this.highlightKeywords(s,o);this.byId("editablePrompt").setValue(n);const a=["#0070f2","#00b050","#ffb100","#d62d20","#a200ff"];const r=o.filter(t=>t.description).map((t,e)=>{const o=a[e%a.length];return`\n                    <div style="margin-bottom:6px; display:flex; align-items:center;">\n                        <span style="\n                            display:inline-block;\n                            background-color:${o};\n                            color:white;\n                            font-weight:bold;\n                            border-radius:4px;\n                            padding:2px 6px;\n                            margin-right:8px;\n                            font-size:0.9rem;\n                        ">${t.number}</span>\n                        <span style="font-size:0.9rem; color:#32363a;">\n                            ${t.description}\n                        </span>\n                    </div>\n                `}).join("");this.byId("legendSection").setContent(r)}catch(t){console.error("Error executing getPrompt:",t)}},highlightKeywords:function(t,e){if(!t||!e||e.length===0)return t;const o=["#0070f2","#00b050","#ffb100","#d62d20","#a200ff"];let s=t;e.forEach((t,e)=>{const n=t.value;if(!n)return;const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");const a=new RegExp(`\\b(${i})\\b`,"gi");const r=o[e%o.length];s=s.replace(a,e=>`<span style="background-color:${r};color:white;padding:2px 4px;border-radius:4px;">${e}<sup>${t.number}</sup></span>`)});return s},onSearchLive:function(){const t=this._oCategorySelect.getSelectedKey();const e=this._oProductSelect.getSelectedKey();this.loadPrompts(t,e)},getBaseUrl:function(){return sap.ui.require.toUrl("intellibasenlq")},fetchCsrfToken:async function(){let t=this.getBaseUrl();const e=await fetch(t,{method:"HEAD",credentials:"include",headers:{"X-CSRF-Token":"Fetch"}});const o=e.headers.get("X-CSRF-Token");return o},onPressButton:async function(){const t=this.byId("editablePrompt").getValue();const e=this.getView();if(!t){i.error("Please select a prompt to proceed!");return}const o=t.replace(/<sup>.*?<\/sup>/gi,"").replace(/<[^>]*>/g,"").trim();const s=new sap.m.BusyDialog({title:"Busy Indicator",text:"Generating response. Please standby.."});s.open();e.setBusy(true);await Promise.resolve();try{const t=await this.onfetchData(o);this.byId("htmlContent").setContent(t)}catch(t){console.error("Chat fetch error:",t);i.error("Failed to get API response due to: ",t)}finally{s.close();e.setBusy(false)}},onfetchData:async function(t){const e=this.getBaseUrl()+"/api/chat";const o=this.getBaseUrl()+"/user-api/currentUser";var s;const n=this.fetchCsrfToken();this.byId("htmlContent").setContent("");const a=new AbortController;const r=setTimeout(()=>{a.abort()},9e4);const c=await fetch(o,{method:"GET",headers:{"X-CSRF-Token":n,"Content-Type":"application/json"}});if(!c.ok){i.error("Not a valid user");return}const l=await c.json();const d=l.name;s={message:"user_id:"+d+":Intellibase "+t};try{const t=await fetch(e,{method:"POST",headers:{"X-CSRF-Token":n,"Content-Type":"application/json"},body:JSON.stringify(s),signal:a.signal});clearTimeout(r);if(!t.ok){throw new Error(`HTTP error! Status: ${t.status}`)}const o=await t.json();const i=o.FINAL_RESULT==="string"&&/<[^>]+>/.test(o.FINAL_RESULT);var p;if(!i){p=`<p style="color:red;">${o.FINAL_RESULT}</p>`}else p=p+"<div style='margin-top:1rem; font-family: monospace; white-space: pre-wrap;'>"+"<strong>SQL Query:</strong><br/>"+o.SQL_QUERY+"</div>";return p}catch(t){console.log("inside catch of askFinsight",t)}},onChatCopy:function(){const t=this.byId("ChatBotResult");const e=t?.getDomRef();if(!e){sap.m.MessageToast.show("Nothing to copy");return}const o=e.innerText;if(navigator?.clipboard&&o){navigator.clipboard.writeText(o).then(()=>{sap.m.MessageToast.show("Text copied to clipboard")}).catch(t=>{console.error("Copy failed",t);sap.m.MessageToast.show("Failed to copy text.")})}},onChatExport:async function(){if(!window.jspdf||!window.html2canvas){sap.m.MessageToast.show("Required libraries not loaded.");return}const{jsPDF:t}=window.jspdf;const e=this.byId("editablePrompt").getValue()||"";const o=e.replace(/<sup>.*?<\/sup>/gi,"").replace(/<[^>]*>/g,"").trim();const s=this.byId("ChatBotResult")?.getDomRef();if(!s){sap.m.MessageToast.show("No content to export");return}const n=document.createElement("div");n.style.width="794px";n.style.padding="20px";n.style.background="#fff";n.style.fontFamily="Arial, sans-serif";n.style.position="absolute";n.style.top="0";n.style.left="-9999px";document.body.appendChild(n);const i=document.createElement("div");i.style.background="linear-gradient(to right, #e8f0ff, #f2f6fd)";i.style.padding="16px 24px";i.style.borderRadius="8px";i.style.marginBottom="24px";i.style.border="1px solid #cdddfb";const a=document.createElement("div");a.textContent="USER INPUT";a.style.fontSize="18px";a.style.fontWeight="bold";a.style.color="#1a73e8";a.style.marginBottom="8px";const r=document.createElement("div");r.textContent=o;r.style.fontSize="14px";r.style.color="#333";i.appendChild(a);i.appendChild(r);n.appendChild(i);const c=s.cloneNode(true);c.style.margin="0";n.appendChild(c);await new Promise(t=>requestAnimationFrame(t));try{const e=await html2canvas(n,{scale:2,useCORS:true,scrollY:0,windowWidth:n.scrollWidth,height:n.scrollHeight});const o=e.toDataURL("image/png");const s=new t("p","pt","a4");const i=s.internal.pageSize.getWidth();const a=s.internal.pageSize.getHeight();const r=i;const c=e.height*i/e.width;let l=c;let d=0;s.addImage(o,"PNG",0,d,r,c);l-=a;while(l>0){d-=a;s.addPage();s.addImage(o,"PNG",0,d,r,c);l-=a}s.save("IntellibaseNLQ_Chat_Export.pdf");sap.m.MessageToast.show("PDF exported successfully")}catch(t){console.error("PDF export failed",t);sap.m.MessageToast.show("Failed to export PDF")}finally{document.body.removeChild(n)}}})});
//# sourceMappingURL=MainView.controller.js.map