sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/StandardListItem","sap/m/MessageBox","sap/m/BusyDialog","../lib/jspdf/jspdf.umd.min","../lib/dompurify/purify.min","../lib/html2canvas/html2canvas.min"],(t,e,o,s,n,i,r)=>{"use strict";return t.extend("intellibasenlq.controller.MainView",{onInit:async function(){this._oODataModel=this.getOwnerComponent().getModel();this._oCategoryModel=new e;this._oProductModel=new e;this.getView().setModel(this._oCategoryModel,"categoriesModel");this.getView().setModel(this._oProductModel,"productsModel");this._oCategorySelect=this.byId("categorySelect");this._oProductSelect=this.byId("productSelect");this._oPromptList=this.byId("promptList");await this.loadCategories();await this.loadProducts();this.loadPrompts("All Categories","All Products")},loadCategories:async function(){const t=this._oODataModel.bindContext("/DistinctCategories(...)");await t.execute();const o=t.getBoundContext().getObject();const s=o.value||[];s.unshift({category:"All Categories"});const n=new e(s);this.getView().setModel(n,"categories")},loadProducts:async function(t){const o=this._oODataModel.bindContext("/DistinctProducts(...)");await o.execute();const s=o.getBoundContext().getObject();const n=s.value||[];n.unshift({product:"All Products"});const i=new e(n);this.getView().setModel(i,"products")},loadPrompts:function(t,e){const i=[];if(t&&t!=="All Categories"){i.push(new o("category",s.EQ,t))}if(e&&e!=="All Products"){i.push(new o("product",s.EQ,e))}const r=this._oPromptList.getBinding("items");if(r){r.filter(i)}else{this._oPromptList.bindItems({path:"/PromptsData",template:new n({title:"{prompt}",description:"{description}"}),filters:i})}},onCategoryChange:function(t){const e=t.getParameter("selectedItem")?.getKey();const o=this._oProductSelect.getSelectedKey();this.loadPrompts(e,o)},onProductChange:function(t){const e=t.getParameter("selectedItem")?.getKey();const o=this._oCategorySelect.getSelectedKey();this.loadPrompts(o,e)},onSelectPrompt:async function(t){this.byId("keywordBox").setVisible(true);this.byId("legendSection").setContent("");const e=t.getParameter("listItem").getBindingContext();const o=e.getObject();const s=o.prompt;const n=this.getView().getModel();const i=n.bindContext("/getPrompt(...)");i.setParameter("prompt",s);try{await i.execute();const t=i.getBoundContext().getObject();const e=Object.entries(t).filter(([t,e])=>t.startsWith("key")&&e);let o=e.map(([e,o],s)=>({value:o,description:t[e.replace("key","sel")],number:s+1}));o=o.map(t=>{const e=s.toLowerCase().indexOf(t.value.toLowerCase());return e>=0?{...t,index:e}:null}).filter(Boolean).sort((t,e)=>t.index-e.index).map((t,e)=>({...t,number:e+1}));const n=this.highlightKeywords(s,o);this.byId("editablePrompt").setValue(n);const r=["#0070f2","#00b050","#ffb100","#d62d20","#a200ff"];const a=`\n            background-color: #ffffff;\n            border-radius: 12px;\n            padding: 12px;\n            max-width: 100%;\n            box-sizing: border-box;\n        `;const l=`\n            <div style="${a}">\n                ${o.filter(t=>t.description).map((t,e)=>{const o=r[e%r.length];const s=String(t.description).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return`\n                            <div\n                                style="\n                                    display:flex;\n                                    align-items:center;\n                                    gap:10px;\n                                    padding:10px 12px;\n                                    margin-bottom:10px;\n                                    border-radius:10px;\n                                    background:#ffffff;\n                                    max-width:100%;\n                                    box-shadow: 0 1px 4px rgba(0,0,0,0.05);\n                                "\n                            >\n                                <div style="\n                                    display:inline-flex;\n                                    align-items:center;\n                                    justify-content:center;\n                                    min-width:28px;\n                                    height:28px;\n                                    border-radius:6px;\n                                    background:${o};\n                                    color:#fff;\n                                    font-weight:600;\n                                    font-size:0.9rem;\n                                    padding:0 8px;\n                                ">${t.number}</div>\n\n                                <div style="\n                                    flex:1;\n                                    font-size:0.92rem;\n                                    font-weight:400;\n                                    color:#32363a;\n                                    white-space:normal;\n                                ">\n                                    ${s}\n                                </div>\n                            </div>\n                        `}).join("")}\n            </div>\n        `;this.byId("legendSection").setContent(l)}catch(t){console.error("Error executing getPrompt:",t)}},highlightKeywords:function(t,e){if(!t||!e||e.length===0)return t;const o=["#0070f2","#00b050","#ffb100","#d62d20","#a200ff"];let s=t;e.forEach((t,e)=>{const n=t.value;if(!n)return;const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");const r=new RegExp(`\\b(${i})\\b`,"gi");const a=o[e%o.length];s=s.replace(r,e=>`<span style="background-color:${a};color:white;padding:2px 4px;border-radius:4px;">${e}<sup>${t.number}</sup></span>`)});return s},onSearchLive:function(){const t=this._oCategorySelect.getSelectedKey();const e=this._oProductSelect.getSelectedKey();this.loadPrompts(t,e)},getBaseUrl:function(){return sap.ui.require.toUrl("intellibasenlq")},fetchCsrfToken:async function(){let t=this.getBaseUrl();const e=await fetch(t,{method:"HEAD",credentials:"include",headers:{"X-CSRF-Token":"Fetch"}});const o=e.headers.get("X-CSRF-Token");return o},onPressButton:async function(){this.byId("htmlContent").setVisible(true);this.byId("ChatBotResult").setVisible(true);const t=this.byId("editablePrompt").getValue();const e=this.getView();if(!t){i.error("Please select a prompt to proceed!");return}const o=t.replace(/<sup>.*?<\/sup>/gi,"").replace(/<[^>]*>/g,"").trim();const s=new sap.m.BusyDialog({title:"Busy Indicator",text:"Generating response. Please standby.."});s.open();e.setBusy(true);await Promise.resolve();try{const t=await this.onfetchData(o);this.byId("htmlContent").setContent(t)}catch(t){console.error("Chat fetch error:",t);i.error("Failed to get API response due to: ",t)}finally{s.close();e.setBusy(false)}},onfetchData:async function(t){const e=this.getBaseUrl()+"/api/chat";const o=this.getBaseUrl()+"/user-api/currentUser";const s=this.fetchCsrfToken();this.byId("htmlContent").setContent("");const n=new AbortController;const r=setTimeout(()=>{n.abort()},9e4);try{const a=await fetch(o,{method:"GET",headers:{"X-CSRF-Token":s,"Content-Type":"application/json"}});if(!a.ok){i.error("Not a valid user");return}const l=await a.json();console.log("Logged in User: ",l);const c=l.name;const d={message:"user_id:"+c+":Intellibase "+t};const p=await fetch(e,{method:"POST",headers:{"X-CSRF-Token":s,"Content-Type":"application/json"},body:JSON.stringify(d),signal:n.signal});clearTimeout(r);if(!p.ok){console.log("API response:",p);throw new Error(`HTTP error! Status: ${p.status}`)}const h=await p.json();console.log("API Data:",h);const g=h.FINAL_RESULT||"";const u=h.SQL_QUERY||"";const f=/<\/?[a-z][\s\S]*>/i.test(g);const m=f?g:`<p style="color:red;">${h.FINAL_RESULT}</p>`;const y="<div style='margin-top:1rem; font-family: monospace; white-space: pre-wrap;'>"+"<strong>SQL Query:</strong><br/>"+h.SQL_QUERY+"</div>";const b=m+y;this.byId("htmlContent").setContent(b);return b}catch(t){console.error("Error in onfetchData:",t);sap.m.MessageBox.error("Error fetching data. Please try again.")}finally{clearTimeout(r)}},_escapeHtml:function(t){if(!t)return"";return t.replace(/[&<>"']/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]})},onChatCopy:function(){const t=this.byId("ChatBotResult");const e=t?.getDomRef();if(!e){sap.m.MessageToast.show("Nothing to copy");return}const o=e.innerText;if(navigator?.clipboard&&o){navigator.clipboard.writeText(o).then(()=>{sap.m.MessageToast.show("Text copied to clipboard")}).catch(t=>{console.error("Copy failed",t);sap.m.MessageToast.show("Failed to copy text.")})}},onChatExport:async function(){if(!window.jspdf||!window.html2canvas){sap.m.MessageToast.show("Required libraries not loaded.");return}const{jsPDF:t}=window.jspdf;const e=this.byId("editablePrompt").getValue()||"";const o=e.replace(/<sup>.*?<\/sup>/gi,"").replace(/<[^>]*>/g,"").trim();const s=this.byId("ChatBotResult")?.getDomRef();if(!s){sap.m.MessageToast.show("No content to export");return}const n=document.createElement("div");n.style.width="794px";n.style.padding="20px";n.style.background="#fff";n.style.fontFamily="Arial, sans-serif";n.style.position="absolute";n.style.top="0";n.style.left="-9999px";document.body.appendChild(n);const i=document.createElement("div");i.style.background="linear-gradient(to right, #e8f0ff, #f2f6fd)";i.style.padding="16px 24px";i.style.borderRadius="8px";i.style.marginBottom="24px";i.style.border="1px solid #cdddfb";const r=document.createElement("div");r.textContent="USER INPUT";r.style.fontSize="18px";r.style.fontWeight="bold";r.style.color="#1a73e8";r.style.marginBottom="8px";const a=document.createElement("div");a.textContent=o;a.style.fontSize="14px";a.style.color="#333";i.appendChild(r);i.appendChild(a);n.appendChild(i);const l=s.cloneNode(true);const c=l.querySelector(".summaryBox");if(c)c.remove();l.style.margin="0";n.appendChild(l);await new Promise(t=>requestAnimationFrame(t));try{const e=await html2canvas(n,{scale:2,useCORS:true,scrollY:0,windowWidth:n.scrollWidth,height:n.scrollHeight});const o=e.toDataURL("image/png");const s=new t("p","pt","a4");const i=s.internal.pageSize.getWidth();const r=s.internal.pageSize.getHeight();const a=i;const l=e.height*i/e.width;let c=l;let d=0;s.addImage(o,"PNG",0,d,a,l);c-=r;while(c>0){d-=r;s.addPage();s.addImage(o,"PNG",0,d,a,l);c-=r}s.save("IntellibaseNLQ_Chat_Export.pdf");sap.m.MessageToast.show("PDF exported successfully")}catch(t){console.error("PDF export failed",t);sap.m.MessageToast.show("Failed to export PDF")}finally{document.body.removeChild(n)}},onPressReset:async function(){const t=this.byId("categorySelect");const e=this.byId("productSelect");if(t)t.setSelectedKey("All Categories");if(e)e.setSelectedKey("All Categories");await this.loadCategories();await this.loadProducts();this.loadPrompts("All Categories","All Products");const o=this.byId("editablePrompt");if(o)o.setValue("");const s=this.byId("legendSection");if(s){this.byId("keywordBox").setVisible(false);s.setContent("")}this.byId("ChatBotResult").setVisible(false);const n=this.byId("htmlContent");if(n)n.setVisible(false);const i=this.byId("ChatBotResult");if(i)i.setContent?.("")||(i.setText?.(""),null)}})});
//# sourceMappingURL=MainView.controller.js.map