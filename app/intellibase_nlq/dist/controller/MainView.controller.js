sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/StandardListItem","sap/m/MessageBox","sap/m/BusyDialog","../lib/jspdf/jspdf.umd.min","../lib/dompurify/purify.min","../lib/html2canvas/html2canvas.min"],(e,t,n,o,s,i,a)=>{"use strict";return e.extend("intellibasenlq.controller.MainView",{onInit:async function(){this._oODataModel=this.getOwnerComponent().getModel();this._oCategoryModel=new t;this._oProductModel=new t;this.getView().setModel(this._oCategoryModel,"categoriesModel");this.getView().setModel(this._oProductModel,"productsModel");this._oCategorySelect=this.byId("categorySelect");this._oProductSelect=this.byId("productSelect");this._oPromptList=this.byId("promptList");await this.loadCategories();await this.loadProducts();this.loadPrompts("All Categories","All Products")},loadCategories:async function(){const e=this._oODataModel.bindContext("/DistinctCategories(...)");await e.execute();const n=e.getBoundContext().getObject();const o=n.value||[];o.unshift({category:"All Categories"});const s=new t(o);this.getView().setModel(s,"categories")},loadProducts:async function(e){const n=this._oODataModel.bindContext("/DistinctProducts(...)");await n.execute();const o=n.getBoundContext().getObject();const s=o.value||[];s.unshift({product:"All Products"});const i=new t(s);this.getView().setModel(i,"products")},loadPrompts:function(e,t){const i=[];if(e&&e!=="All Categories"){i.push(new n("category",o.EQ,e))}if(t&&t!=="All Products"){i.push(new n("product",o.EQ,t))}const a=this._oPromptList.getBinding("items");if(a){a.filter(i)}else{this._oPromptList.bindItems({path:"/PromptsData",template:new s({title:"{prompt}",description:"{description}"}),filters:i})}},onCategoryChange:function(e){const t=e.getParameter("selectedItem")?.getKey();const n=this._oProductSelect.getSelectedKey();this.loadPrompts(t,n)},onProductChange:function(e){const t=e.getParameter("selectedItem")?.getKey();const n=this._oCategorySelect.getSelectedKey();this.loadPrompts(n,t)},onSelectPrompt:async function(e){this.byId("legendSection").setContent("");const t=e.getParameter("listItem").getBindingContext();const n=t.getObject();const o=n.prompt;const s=this.getView().getModel();const i=s.bindContext("/getPrompt(...)");i.setParameter("prompt",o);try{await i.execute();const e=i.getBoundContext().getObject();const t=Object.entries(e).filter(([e,t])=>e.startsWith("key")&&t);let n=t.map(([t,n],o)=>({value:n,description:e[t.replace("key","sel")],number:o+1}));n=n.map(e=>{const t=o.toLowerCase().indexOf(e.value.toLowerCase());return t>=0?{...e,index:t}:null}).filter(Boolean).sort((e,t)=>e.index-t.index).map((e,t)=>({...e,number:t+1}));const s=this.highlightKeywords(o,n);this.byId("editablePrompt").setValue(s);const a=["#0070f2","#00b050","#ffb100","#d62d20","#a200ff"];const r=n.filter(e=>e.description).map((e,t)=>{const n=a[t%a.length];return`\n                    <div style="margin-bottom:6px; display:flex; align-items:center;">\n                        <span style="\n                            display:inline-block;\n                            background-color:${n};\n                            color:white;\n                            font-weight:bold;\n                            border-radius:4px;\n                            padding:2px 6px;\n                            margin-right:8px;\n                            font-size:0.9rem;\n                        ">${e.number}</span>\n                        <span style="font-size:0.9rem; color:#32363a;">\n                            ${e.description}\n                        </span>\n                    </div>\n                `}).join("");this.byId("legendSection").setContent(r)}catch(e){console.error("Error executing getPrompt:",e)}},highlightKeywords:function(e,t){if(!e||!t||t.length===0)return e;const n=["#0070f2","#00b050","#ffb100","#d62d20","#a200ff"];let o=e;t.forEach((e,t)=>{const s=e.value;if(!s)return;const i=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");const a=new RegExp(`\\b(${i})\\b`,"gi");const r=n[t%n.length];o=o.replace(a,t=>`<span style="background-color:${r};color:white;padding:2px 4px;border-radius:4px;">${t}<sup>${e.number}</sup></span>`)});return o},onSearchLive:function(){const e=this._oCategorySelect.getSelectedKey();const t=this._oProductSelect.getSelectedKey();this.loadPrompts(e,t)},getBaseUrl:function(){return sap.ui.require.toUrl("intellibasenlq")},fetchCsrfToken:async function(){let e=this.getBaseUrl();const t=await fetch(e,{method:"HEAD",credentials:"include",headers:{"X-CSRF-Token":"Fetch"}});const n=t.headers.get("X-CSRF-Token");return n},onPressButton:async function(){const e=this.byId("editablePrompt").getValue();const t=this.getView();if(!e){i.error("Please select a prompt to proceed!");return}const n=e.replace(/<sup>.*?<\/sup>/gi,"").replace(/<[^>]*>/g,"").trim();const o=new sap.m.BusyDialog({title:"Busy Indicator",text:"Generating response. Please standby.."});o.open();t.setBusy(true);await Promise.resolve();try{var s=`<p style="color:red;"><p style="color:gray;"><em>âœ¨ Generated by FinSight.Intelligence. Please review before use.</em></p>\n \n<h2>Executive Summary</h2>\n<p>The financial institution delivered robust performance in Q1'25 with operating income reaching $5,390mn, marking a 7% YoY increase, while achieving 12% YoY income growth excluding notables. The Corporate & Investment Banking division showed particular strength with Global Markets and Global Banking segments growing 14% and 17% YoY respectively. Wealth & Retail Banking demonstrated impressive momentum with a 12% YoY income increase, supported by strong growth in Investment Products (33%) and Bancassurance (15% YoY), while Affluent AUM reached $389bn, representing a 6% QoQ improvement.</p>\n \n<h2>Q1 2025 Financial Performance Analysis</h2>\n<ul>\n    <li><strong>Core Performance Metrics</strong>\n        <ul>\n            <li>Operating income: $5,390mn (+7% YoY)</li>\n            <li>Earnings per share: 19% YoY increase</li>\n            <li>CET1 ratio: 13.8% (39bps decrease QoQ)</li>\n            <li>Liquidity Coverage Ratio (LCR): 147%</li>\n        </ul>\n    </li>\n    <li><strong>Corporate & Investment Banking</strong>\n        <ul>\n            <li>Overall income: +4% YoY</li>\n            <li>Global Markets: +14% YoY</li>\n            <li>Global Banking: +17% YoY</li>\n            <li>Transaction Services: -4% YoY</li>\n        </ul>\n    </li>\n    <li><strong>Wealth & Retail Banking</strong>\n        <ul>\n            <li>Overall income: +12% YoY</li>\n            <li>Investment Products: +33%</li>\n            <li>Bancassurance: +15% YoY</li>\n            <li>Affluent AUM: $389bn (+6% QoQ)</li>\n        </ul>\n    </li>\n    <li><strong>Strategic Outlook & Targets</strong>\n        <ul>\n            <li>Operating expenses target: <$12.3bn by 2026</li>\n            <li>CET1 ratio target range: 13-14%</li>\n            <li>Planned shareholder returns: Minimum $8bn (2024-2026)</li>\n            <li>RoTE target: Approaching 13% in 2026</li>\n        </ul>\n    </li>\n</ul></p>`;this.byId("htmlContent").setContent(s)}catch(e){console.error("Chat fetch error:",e);i.error("Failed to get API response due to: ",e)}finally{o.close();t.setBusy(false)}},onfetchData:async function(e){const t=this.getBaseUrl()+"/api/chat";const n=this.getBaseUrl()+"/user-api/currentUser";var o;const s=this.fetchCsrfToken();this.byId("htmlContent").setContent("");const a=new AbortController;const r=setTimeout(()=>{a.abort()},9e4);const l=await fetch(n,{method:"GET",headers:{"X-CSRF-Token":s,"Content-Type":"application/json"}});if(!l.ok){i.error("Not a valid user");return}const c=await l.json();const d=c.name;o={message:"user_id:8226627:Intellibase For bonds in Kenya country, calculate weighted average Market yield."};const p=JSON.stringify(o);try{const e=await fetch(t,{method:"POST",headers:{"X-CSRF-Token":s,"Content-Type":"application/json"},body:p});clearTimeout(r);if(!e.ok){throw new Error(`HTTP error! Status: ${e.status}`)}const n=await e.json();const o=n.FINAL_RESULT==="string"&&/<[^>]+>/.test(n.FINAL_RESULT);var g;if(!o){g=`<p style="color:red;">${n.FINAL_RESULT}</p>`}else g=g+"<div style='margin-top:1rem; font-family: monospace; white-space: pre-wrap;'>"+"<strong>SQL Query:</strong><br/>"+n.SQL_QUERY+"</div>";return g}catch(e){console.log("inside catch of askFinsight",e)}},onChatCopy:function(){const e=this.byId("ChatBotResult");const t=e?.getDomRef();if(!t){sap.m.MessageToast.show("Nothing to copy");return}const n=t.innerText;if(navigator?.clipboard&&n){navigator.clipboard.writeText(n).then(()=>{sap.m.MessageToast.show("Text copied to clipboard")}).catch(e=>{console.error("Copy failed",e);sap.m.MessageToast.show("Failed to copy text.")})}},onChatExport:async function(){if(!window.jspdf||!window.html2canvas){sap.m.MessageToast.show("Required libraries not loaded.");return}const{jsPDF:e}=window.jspdf;const t=this.byId("editablePrompt").getValue()||"";const n=t.replace(/<sup>.*?<\/sup>/gi,"").replace(/<[^>]*>/g,"").trim();const o=this.byId("ChatBotResult")?.getDomRef();if(!o){sap.m.MessageToast.show("No content to export");return}const s=document.createElement("div");s.style.width="794px";s.style.padding="20px";s.style.background="#fff";s.style.fontFamily="Arial, sans-serif";s.style.position="absolute";s.style.top="0";s.style.left="-9999px";document.body.appendChild(s);const i=document.createElement("div");i.style.background="linear-gradient(to right, #e8f0ff, #f2f6fd)";i.style.padding="16px 24px";i.style.borderRadius="8px";i.style.marginBottom="24px";i.style.border="1px solid #cdddfb";const a=document.createElement("div");a.textContent="USER INPUT";a.style.fontSize="18px";a.style.fontWeight="bold";a.style.color="#1a73e8";a.style.marginBottom="8px";const r=document.createElement("div");r.textContent=n;r.style.fontSize="14px";r.style.color="#333";i.appendChild(a);i.appendChild(r);s.appendChild(i);const l=o.cloneNode(true);l.style.margin="0";s.appendChild(l);await new Promise(e=>requestAnimationFrame(e));try{const t=await html2canvas(s,{scale:2,useCORS:true,scrollY:0,windowWidth:s.scrollWidth,height:s.scrollHeight});const n=t.toDataURL("image/png");const o=new e("p","pt","a4");const i=o.internal.pageSize.getWidth();const a=o.internal.pageSize.getHeight();const r=i;const l=t.height*i/t.width;let c=l;let d=0;o.addImage(n,"PNG",0,d,r,l);c-=a;while(c>0){d-=a;o.addPage();o.addImage(n,"PNG",0,d,r,l);c-=a}o.save("IntellibaseNLQ_Chat_Export.pdf");sap.m.MessageToast.show("PDF exported successfully")}catch(e){console.error("PDF export failed",e);sap.m.MessageToast.show("Failed to export PDF")}finally{document.body.removeChild(s)}},onPressReset:async function(){const e=this.byId("categorySelect");const t=this.byId("productSelect");if(e)e.setSelectedKey("All Categories");if(t)t.setSelectedKey("All Categories");await this.loadCategories();await this.loadProducts();this.loadPrompts("All Categories","All Products");const n=this.byId("editablePrompt");if(n)n.setValue("");const o=this.byId("legendSection");if(o){this.byId("keywordBox").setContent("");o.setContent("")}const s=this.byId("htmlContent");if(s)s.setContent("");const i=this.byId("ChatBotResult");if(i)i.setContent?.("")||(i.setText?.(""),null)}})});
//# sourceMappingURL=MainView.controller.js.map